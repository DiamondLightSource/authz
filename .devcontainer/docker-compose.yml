version: "3.8"

services:
  bundler:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ..:/workspace:cached,z
    command: sleep infinity
    environment:
      DATABASE_URL: mysql://root:rootpassword@ispyb/ispyb_build
      BUNDLER_DATABASE_URL: mysql://root:rootpassword@ispyb/ispyb_build
      BUNDLER_LOG_LEVEL: DEBUG
      BUNDLER_TRACING_URL: http://jaeger:4317

  opa:
    image: docker.io/openpolicyagent/opa:0.59.0
    restart: unless-stopped
    command: >
      run
      --server
      --config-file /config.yml
      --watch
      /org-policy
    volumes:
      - ./opa.yml:/config.yml:cached,z
      - ../org-policy/:/org-policy:cached,z
    environment:
      TRACING_ADDRESS: jaeger:4317

  ispyb:
    image: ghcr.io/diamondlightsource/ispyb-database:v3.0.0
    restart: unless-stopped
    environment:
      MARIADB_ROOT_PASSWORD: rootpassword

  jaeger:
    image: docker.io/jaegertracing/all-in-one:1.52.0
    restart: unless-stopped
    ports:
      - 16686:16686
